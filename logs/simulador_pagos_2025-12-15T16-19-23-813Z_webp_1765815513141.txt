===== QA | Simulador de Pagos DIRI - EJECUCIÓN =====
Fecha/hora servidor (ISO): 2025-12-15T16:19:23.813Z

---- RESUMEN GENERAL ----
STATUS FINAL: OK
MENSAJE: Flujo OpenPay ejecutado → Webhook PROD encontrado → Insertado en UAT → Metadata recuperada → JSON para webhookopenpay construido → Notificación reprocesada por API webhookopenpay → Validación en tablas de negocio UAT y en MongoDB.

---- CONTEXTO DE ENTRADA ----
Folio de compra: webp_1765815513141
Marca (brandNumber): 17
DN: 5612457662
Pasarela: openpay
Tipo de operación: recarga

---- LOG PASO A PASO ----
- Recibí folioCompra = webp_1765815513141
- Marca / brandNumber = 17
- Pasarela seleccionada = openpay
- Tipo de operación = recarga
- DN utilizado = 5612457662
- Llamando API detalle consumo DN (ANTES_DE_REPROCESO) webresources/consultaConsumo (POST)...
- API detalle consumo DN (ANTES_DE_REPROCESO) respondió correctamente: HTTP 200.
- Iniciando flujo OpenPay: webhook PROD → UAT → construcción JSON → API webhookopenpay → validaciones.
- Consultando BD PROD OpenPay (diri_webhook_openpay) por folio...
- Registro OpenPay encontrado en PROD.
- Verificando si ya existe registro OpenPay en UAT para ese folio...
- No existía registro OpenPay en UAT; insertando registro en UAT...
- Registro OpenPay insertado en UAT con id = 400910
- Recuperando registro OpenPay desde UAT para obtener metadata después del insert...
- Metadata obtenida desde registro OpenPay en UAT; se intenta parsear como JSON.
- Metadata OpenPay en UAT parseada correctamente como JSON.
- Campos relevantes extraídos de metadata OpenPay: creation_date, operation_date, order_id, reference, amount, email, phone_number.
- JSON OpenPay para webhookopenpay construido con sustitución de los campos dinámicos indicados.
- Llamando API webhookopenpay (POST) para reprocesar OpenPay...
- API webhookopenpay respondió con status HTTP 200, codRespuesta = OK, detalle = SE PROCESO CON EXITO LA PETICION
- API webhookopenpay procesó la notificación OpenPay con éxito (codRespuesta OK).
- Validando en tabla de negocio UAT: diriprod.diri_recarga (recarga, estatus OK/PAGADO)...
- Recarga en UAT encontrada con estatus exitoso (OK) para ese folio.
- Validando folioCompra en MongoDB ECOMMERCEDB.tbl_orders por patrón en _id...
- Orden encontrada en MongoDB para ese folioCompra.
- Estado en MongoDB considerado exitoso (PAID) para ese folio.
- Llamando API detalle consumo DN (DESPUES_DE_REPROCESO) webresources/consultaConsumo (POST)...
- API detalle consumo DN (DESPUES_DE_REPROCESO) respondió correctamente: HTTP 200.
- Se detectaron 5 diferencias en la respuesta de detalle consumo DN entre ANTES y DESPUES del reproceso.

---- DETALLE CONSUMO DN - ANTES_DE_REPROCESO ----
{
  "codRespuesta": "OK",
  "detalle": "SE PROCESO CON EXITO LA PETICION",
  "perfilClienteApp": {
    "lineas": [
      {
        "datoslinea": {
          "dn": "5612457662",
          "esprincipal": "1",
          "fechacorte": "15-01-2026",
          "offeridaltan": "1509944009",
          "plancontratado": "MIFI 5GB",
          "tipo": "prepago",
          "codigoplanref": "b183f1",
          "recargaVigente": "SI",
          "fechasRecarga": {
            "ultimarecarga": "2025-12-15 10:13:02",
            "vigenciarecarga": "2026-01-15 12:00:00"
          },
          "nobanda28": "NO",
          "categoria_plan": "NORMAL"
        },
        "subscriber": {
          "msisdn": "5612457662",
          "imsi": "334140217467280",
          "iccid": "8952140063585004750",
          "imei": "35983473657467",
          "status": "Active",
          "product": "Mifi",
          "coordinates": ","
        },
        "sms": {
          "disponible": 0,
          "consumo": 0,
          "total": 0,
          "ilimitado": "NO"
        },
        "voz": {
          "disponible": 0,
          "consumo": 0,
          "total": 0,
          "ilimitado": "NO"
        },
        "datos": {
          "disponible": 34.4,
          "consumo": 0.6,
          "total": 35,
          "ilimitado": "NO"
        },
        "rs": {
          "disponible": 21.1,
          "consumo": 0,
          "total": 21.1,
          "ilimitado": "NO"
        },
        "throttlin": {
          "disponible": 0,
          "consumo": 0,
          "total": 0,
          "ilimitado": "NO"
        }
      }
    ],
    "fallaAltan": false
  }
}

---- DETALLE CONSUMO DN - DESPUES_DE_REPROCESO ----
{
  "codRespuesta": "OK",
  "detalle": "SE PROCESO CON EXITO LA PETICION",
  "perfilClienteApp": {
    "lineas": [
      {
        "datoslinea": {
          "dn": "5612457662",
          "esprincipal": "1",
          "fechacorte": "15-01-2026",
          "offeridaltan": "1509944009",
          "plancontratado": "MIFI 5GB",
          "tipo": "prepago",
          "codigoplanref": "b183f1",
          "recargaVigente": "SI",
          "fechasRecarga": {
            "ultimarecarga": "2025-12-15 10:19:16",
            "vigenciarecarga": "2026-01-15 12:00:00"
          },
          "nobanda28": "NO",
          "categoria_plan": "NORMAL"
        },
        "subscriber": {
          "msisdn": "5612457662",
          "imsi": "334140217467280",
          "iccid": "8952140063585004750",
          "imei": "35983473657467",
          "status": "Active",
          "product": "Mifi",
          "coordinates": ","
        },
        "sms": {
          "disponible": 0,
          "consumo": 0,
          "total": 0,
          "ilimitado": "NO"
        },
        "voz": {
          "disponible": 0,
          "consumo": 0,
          "total": 0,
          "ilimitado": "NO"
        },
        "datos": {
          "disponible": 39.4,
          "consumo": 0.6,
          "total": 40,
          "ilimitado": "NO"
        },
        "rs": {
          "disponible": 24.1,
          "consumo": 0,
          "total": 24.1,
          "ilimitado": "NO"
        },
        "throttlin": {
          "disponible": 0,
          "consumo": 0,
          "total": 0,
          "ilimitado": "NO"
        }
      }
    ],
    "fallaAltan": false
  }
}

---- DIFERENCIAS DETALLE CONSUMO (ANTES vs DESPUES) ----
[
  {
    "path": "perfilClienteApp.lineas[0].datoslinea.fechasRecarga.ultimarecarga",
    "antes": "2025-12-15 10:13:02",
    "despues": "2025-12-15 10:19:16"
  },
  {
    "path": "perfilClienteApp.lineas[0].datos.disponible",
    "antes": 34.4,
    "despues": 39.4
  },
  {
    "path": "perfilClienteApp.lineas[0].datos.total",
    "antes": 35,
    "despues": 40
  },
  {
    "path": "perfilClienteApp.lineas[0].rs.disponible",
    "antes": 21.1,
    "despues": 24.1
  },
  {
    "path": "perfilClienteApp.lineas[0].rs.total",
    "antes": 21.1,
    "despues": 24.1
  }
]

---- DETALLE OPENPAY ----
>>> Registro PROD (diri_webhook_openpay):
{
  "id": 400910,
  "folio": "webp_1765815513141",
  "referencia": "1010101704115654",
  "orderid": "trufaflmwzsfqr811qjy",
  "autorizacion": "NA",
  "tipo": "charge.created",
  "metadata": "{\"type\":\"charge.created\",\"event_date\":\"2025-12-15T10:18:33-06:00\",\"transaction\":{\"id\":\"trufaflmwzsfqr811qjy\",\"authorization\":null,\"operation_type\":\"in\",\"transaction_type\":\"charge\",\"status\":\"in_progress\",\"conciliated\":false,\"creation_date\":\"2025-12-15T10:18:33-06:00\",\"operation_date\":\"2025-12-15T10:18:33-06:00\",\"description\":\"1509944009\",\"error_message\":null,\"order_id\":\"webp_1765815513141\",\"amount\":150.00,\"customer\":{\"name\":\"Recarga Diri\",\"last_name\":\"DIRI-tienda\",\"email\":\"evillegas@diri.mx\",\"phone_number\":\"5612457662\",\"address\":null,\"creation_date\":\"2025-12-15T10:18:33-06:00\",\"external_id\":null,\"clabe\":null},\"payment_method\":{\"type\":\"store\",\"reference\":\"1010101704115654\",\"barcode_url\":\"https://api.openpay.mx/barcode/1010101704115654?width=1&height=45&text=false\",\"url_store\":\"https://api.openpay.mx/v1/ml8cfrcrzalre5r4eqeb/customers/736588715/trufaflmwzsfqr811qjy/store_confirm\"},\"currency\":\"MXN\",\"method\":\"store\"}}",
  "codigo_verificacion": "NA",
  "fecha_registro": "2025-12-15T16:18:42.000Z"
}
>>> Resultado insert en UAT (OpenPay):
{
  "insertId": 400910,
  "affectedRows": 1
}
>>> Metadata Raw OpenPay:
"{\"type\":\"charge.created\",\"event_date\":\"2025-12-15T10:18:33-06:00\",\"transaction\":{\"id\":\"trufaflmwzsfqr811qjy\",\"authorization\":null,\"operation_type\":\"in\",\"transaction_type\":\"charge\",\"status\":\"in_progress\",\"conciliated\":false,\"creation_date\":\"2025-12-15T10:18:33-06:00\",\"operation_date\":\"2025-12-15T10:18:33-06:00\",\"description\":\"1509944009\",\"error_message\":null,\"order_id\":\"webp_1765815513141\",\"amount\":150.00,\"customer\":{\"name\":\"Recarga Diri\",\"last_name\":\"DIRI-tienda\",\"email\":\"evillegas@diri.mx\",\"phone_number\":\"5612457662\",\"address\":null,\"creation_date\":\"2025-12-15T10:18:33-06:00\",\"external_id\":null,\"clabe\":null},\"payment_method\":{\"type\":\"store\",\"reference\":\"1010101704115654\",\"barcode_url\":\"https://api.openpay.mx/barcode/1010101704115654?width=1&height=45&text=false\",\"url_store\":\"https://api.openpay.mx/v1/ml8cfrcrzalre5r4eqeb/customers/736588715/trufaflmwzsfqr811qjy/store_confirm\"},\"currency\":\"MXN\",\"method\":\"store\"}}"
>>> Metadata Parseada OpenPay:
{
  "type": "charge.created",
  "event_date": "2025-12-15T10:18:33-06:00",
  "transaction": {
    "id": "trufaflmwzsfqr811qjy",
    "authorization": null,
    "operation_type": "in",
    "transaction_type": "charge",
    "status": "in_progress",
    "conciliated": false,
    "creation_date": "2025-12-15T10:18:33-06:00",
    "operation_date": "2025-12-15T10:18:33-06:00",
    "description": "1509944009",
    "error_message": null,
    "order_id": "webp_1765815513141",
    "amount": 150,
    "customer": {
      "name": "Recarga Diri",
      "last_name": "DIRI-tienda",
      "email": "evillegas@diri.mx",
      "phone_number": "5612457662",
      "address": null,
      "creation_date": "2025-12-15T10:18:33-06:00",
      "external_id": null,
      "clabe": null
    },
    "payment_method": {
      "type": "store",
      "reference": "1010101704115654",
      "barcode_url": "https://api.openpay.mx/barcode/1010101704115654?width=1&height=45&text=false",
      "url_store": "https://api.openpay.mx/v1/ml8cfrcrzalre5r4eqeb/customers/736588715/trufaflmwzsfqr811qjy/store_confirm"
    },
    "currency": "MXN",
    "method": "store"
  }
}
>>> Body enviado a API webhookopenpay:
{
  "type": "charge.succeeded",
  "event_date": "2025-12-10T16:02:31-06:00",
  "transaction": {
    "id": "trqvchpibshq708tglsm",
    "authorization": "087811",
    "operation_type": "in",
    "transaction_type": "charge",
    "status": "completed",
    "conciliated": false,
    "creation_date": "2025-12-15T10:18:33-06:00",
    "operation_date": "2025-12-15T10:18:33-06:00",
    "description": null,
    "error_message": null,
    "order_id": "webp_1765815513141",
    "amount": 150,
    "currency": "MXN",
    "payment_method": {
      "type": "store",
      "reference": "1010101704115654",
      "barcode_url": "https://api.openpay.mx/barcode/1010101344144225?width=1&height=45&text=false",
      "url_store": "https://api.openpay.mx/v1/ml8cfrcrzalre5r4eqeb/customers/734709707/trqvchpibshq708tglsm/store_confirm"
    },
    "customer": {
      "name": "Edgar",
      "last_name": "DIRI-equipo",
      "email": "evillegas@diri.mx",
      "phone_number": "5612457662",
      "address": {
        "line1": "NA",
        "line2": "NA",
        "line3": "NA",
        "state": "NA",
        "city": "NA",
        "postal_code": "NA",
        "country_code": "NA"
      },
      "creation_date": "2025-12-15T10:18:33-06:00",
      "external_id": null,
      "clabe": null
    },
    "fee": {
      "amount": 9.14,
      "tax": 1.4624,
      "surcharge": null,
      "base_commission": null,
      "currency": "MXN"
    },
    "method": "store"
  }
}
>>> Respuesta API webhookopenpay:
{
  "codRespuesta": "OK",
  "detalle": "SE PROCESO CON EXITO LA PETICION"
}

---- MONGODB ECOMMERCEDB.tbl_orders ----
Orden encontrada: Sí
{
  "_id": "webp_1765815513141",
  "customer": {
    "name": "Recarga Diri",
    "surname_first": "Recarga Diri",
    "surname_second": "Recarga Diri",
    "email": "evillegas@diri.mx",
    "phone": "5612457662",
    "birth_date": "",
    "nacionality": "",
    "gender": "",
    "identifier_type": "",
    "identifier_number": "",
    "phone_cell": "5612457662",
    "phone_home": "5612457662",
    "phone_bussines": "5612457662"
  },
  "shipping_address": {
    "street": "RECARGA - DIRI",
    "num_ext": "RECARGA - DIRI",
    "num_int": "RECARGA - DIRI",
    "postal_code": "00000",
    "neighborhood": "RECARGA - DIRI",
    "crosstreet": "RECARGA - DIRI",
    "reference": "1509944009"
  },
  "products": [
    {
      "name": "Plan",
      "referencia": "DIRI-MP-RM-NR-BE-5000M-3000RS-30D",
      "phone_number": "5612457662",
      "portable": false,
      "portability_nip": "",
      "import": 150,
      "locked_hours": 72,
      "payment_form": "OPENPAY",
      "quotas_number": 1
    }
  ],
  "created_date": "1765815513590",
  "status": "PAID",
  "expiration_date": "2025-12-15 16:18:33",
  "ip": "148.244.132.38",
  "link": "https://confirma.diri.mx/order?folio=webp_1765815513141",
  "imei": "NA",
  "notify": "mail",
  "channel": "web",
  "oxxo_reference": "1010101704115654",
  "oxxo_barcode": "https://api.openpay.mx/barcode/1010101704115654?width=1&height=45&text=false",
  "oxxo_barcode_url": "https://api.openpay.mx/barcode/1010101704115654?width=1&height=45&text=false",
  "processed": false,
  "fulfilled": false,
  "delivered": false,
  "process_date": "",
  "_class": "com.diri.orders.model.Order"
}
