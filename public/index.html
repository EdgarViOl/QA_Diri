<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>QA | Simulador de Pagos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-body: #f3f4f6;
      --bg-card: #ffffff;
      --border-soft: #e5e7eb;
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --ok: #16a34a;
      --error: #dc2626;
      --warn: #f59e0b;
      --text-main: #111827;
      --text-muted: #6b7280;
      --code-bg: #111827;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: var(--bg-body);
      color: var(--text-main);
    }

    .wrapper {
      max-width: 720px;
      margin: 0 auto;
    }

    .header-card {
      background: linear-gradient(135deg, #0f172a, #1e293b);
      color: #f9fafb;
      border-radius: 12px 12px 0 0;
      padding: 20px 20px 16px;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.35);
    }

    .header-title {
      font-size: 1.4rem;
      margin: 0 0 4px;
      font-weight: 600;
    }

    .header-subtitle {
      font-size: 0.9rem;
      margin: 0;
      color: #cbd5f5;
    }

    .main-card {
      background: var(--bg-card);
      border-radius: 0 0 12px 12px;
      padding: 16px 20px 20px;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.15);
      border: 1px solid rgba(148, 163, 184, 0.4);
      border-top: none;
      margin-bottom: 16px;
    }

    .section {
      border-bottom: 1px solid var(--border-soft);
      padding-bottom: 12px;
      margin-bottom: 12px;
    }

    .section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .section-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin: 0 0 8px;
      color: var(--text-main);
    }

    label {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-main);
    }

    input[type="text"],
    input[type="date"],
    select {
      width: 100%;
      max-width: 320px;
      padding: 7px 10px;
      margin-top: 4px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
    }

    input[type="text"]:focus,
    input[type="date"]:focus,
    select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
    }

    .field-row {
      margin-bottom: 10px;
    }

    .radio-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 6px;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .radio-group label {
      font-weight: 400;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .buttons-row {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    button {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    button.primary {
      background: var(--primary);
      color: #ffffff;
    }

    button.primary:hover:not(:disabled) {
      background: var(--primary-dark);
    }

    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }

    button.secondary:hover:not(:disabled) {
      background: #d1d5db;
    }

    button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .status-bar {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .status-ok {
      background: #ecfdf3;
      color: var(--ok);
    }

    .status-error {
      background: #fef2f2;
      color: var(--error);
    }

    .status-warning {
      background: #fffbeb;
      color: var(--warn);
    }

    .status-idle {
      background: #eff6ff;
      color: #1d4ed8;
    }

    .status-running {
      background: #e0f2fe;
      color: #0369a1;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #9ca3af;
    }

    .status-ok .status-dot {
      background: var(--ok);
    }

    .status-error .status-dot {
      background: var(--error);
    }

    .status-warning .status-dot {
      background: var(--warn);
    }

    .status-idle .status-dot {
      background: #3b82f6;
    }

    .status-running .status-dot {
      background: #0284c7;
    }

    .summary-message {
      font-size: 0.9rem;
      margin-bottom: 4px;
    }

    .summary-keydata {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .summary-keydata strong {
      color: var(--text-main);
    }

    .steps-list {
      list-style: none;
      padding-left: 0;
      margin: 0;
      font-size: 0.85rem;
    }

    .steps-list li {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      padding: 3px 0;
    }

    .step-icon {
      margin-top: 4px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .step-ok .step-icon {
      background: var(--ok);
    }

    .step-error .step-icon {
      background: var(--error);
    }

    .step-neutral .step-icon {
      background: #9ca3af;
    }

    .step-text {
      color: var(--text-muted);
    }

    .details-container {
      margin-top: 10px;
      display: none;
    }

    .details-container pre {
      max-height: 420px;
      overflow: auto;
      background: var(--code-bg);
      color: #e5e7eb;
      padding: 10px;
      border-radius: 8px;
      font-size: 0.8rem;
      line-height: 1.4;
    }

    .details-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .details-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
    }

    .hidden {
      display: none;
    }

    @media (max-width: 600px) {
      .header-card, .main-card {
        padding: 14px 14px 12px;
      }

      .header-title {
        font-size: 1.15rem;
      }

      .header-subtitle {
        font-size: 0.8rem;
      }

      input[type="text"],
      input[type="date"],
      select {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="header-card">
      <a href="https:%2F%2Fwww.diri.mx/" title="" target="_blank">
        <img src="https://pinpointemailimagenes.s3.amazonaws.com/DIRI_EMAILS/renov_anual/diri_blanco.png" alt="Logo diri blanco" width="100" style="display:block;border:0;width:20%;height:auto;margin:0 auto">
      </a>
      <div class="header-title">QA | Simulador de Pagos</div>
      <p class="header-subtitle">
        Ejecución orquestada: Pasarela → Webhook → dbPROD → dbUAT → APIs → MongoDB.
      </p>
    </div>

    <div class="main-card">
      <!-- Sección: Filtros / Entrada -->
      <div class="section">
        <div class="section-title">Entrada de búsqueda</div>
        <form id="flowForm">
          <div class="field-row">
            <label for="folioCompra">Folio de compra:</label><br />
            <input
              type="text"
              id="folioCompra"
              name="folioCompra"
              required
              placeholder="Ej. ugpd_1764606325675"
            />
          </div>

          <div class="field-row">
            <label for="brandNumber">Número de marca:</label><br />
            <input
              type="text"
              id="brandNumber"
              name="brandNumber"
              placeholder="Ej. 1,2,5,12,16"
            />
          </div>

          <div class="field-row">
            <label for="dn">DN utilizado (10 dígitos):</label><br />
            <input
              type="text"
              id="dn"
              name="dn"
              maxlength="10"
              required
              placeholder="Ej. 5512345678"
            />
          </div>

          <div class="field-row">
            <label for="gateway">Pasarela de pago:</label><br />
            <select id="gateway" name="gateway">
              <option value="mercadopago">MercadoPago</option>
              <option value="paypal">PayPal</option>
              <option value="openpay">OpenPay</option>
              <option value="stripe">Stripe</option>
            </select>
          </div>

          <div class="field-row hidden" id="purchaseDateRow">
            <label for="purchaseDate">Fecha de compra (solo PayPal):</label><br />
            <input
              type="date"
              id="purchaseDate"
              name="purchaseDate"
              placeholder="YYYY-MM-DD"
            />
          </div>

          <div class="field-row">
            <label>Tipo de operación:</label>
            <div class="radio-group">
              <label>
                <input
                  type="radio"
                  name="tipoOperacion"
                  value="recarga"
                  checked
                />
                Recarga
              </label>
              <label>
                <input
                  type="radio"
                  name="tipoOperacion"
                  value="compra"
                />
                Compra
              </label>
            </div>
          </div>

          <div class="buttons-row">
            <button type="submit" class="primary" id="runButton">
              Ejecutar flujo
            </button>
            <button type="button" class="secondary" id="clearButton">
              Limpiar
            </button>
          </div>
        </form>
      </div>

      <!-- Sección: Resumen / Estado -->
      <div class="section" id="summarySection">
        <div id="statusChip" class="status-bar status-idle">
          <span class="status-dot"></span>
          <span>Listo para ejecutar</span>
        </div>

        <div class="summary-message" id="summaryMessage">
          Ingresar folio de compra y ejecutar el flujo.
        </div>
        <div class="summary-keydata" id="summaryKeyData"></div>

        <!-- Botón de descarga de reporte TXT (última ejecución) -->
        <div id="downloadReportContainer" class="hidden">
          <button type="button" class="primary" id="downloadReportButton">
            Descargar reporte TXT
          </button>
        </div>
      </div>

      <!-- Sección: Checklist de pasos -->
      <div class="section hidden" id="stepsSection">
        <div class="section-title">Pasos del flujo</div>
        <ul class="steps-list" id="stepsList"></ul>
      </div>

      <!-- Sección: Detalles -->
      <div class="section hidden" id="detailsSection">
        <div class="details-header">
          <div class="details-title">Detalle técnico de la ejecución</div>
          <button class="secondary" type="button" id="toggleDetailsButton">
            Ver detalles
          </button>
        </div>
        <div class="details-container" id="detailsContainer">
          <pre id="detailsPre"></pre>
        </div>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById("flowForm");
    const runButton = document.getElementById("runButton");
    const clearButton = document.getElementById("clearButton");

    const statusChip = document.getElementById("statusChip");
    const summaryMessage = document.getElementById("summaryMessage");
    const summaryKeyData = document.getElementById("summaryKeyData");

    const downloadReportContainer = document.getElementById("downloadReportContainer");
    const downloadReportButton = document.getElementById("downloadReportButton");

    const stepsSection = document.getElementById("stepsSection");
    const stepsList = document.getElementById("stepsList");

    const detailsSection = document.getElementById("detailsSection");
    const toggleDetailsButton = document.getElementById("toggleDetailsButton");
    const detailsContainer = document.getElementById("detailsContainer");
    const detailsPre = document.getElementById("detailsPre");

    const gatewaySelect = document.getElementById("gateway");
    const purchaseDateRow = document.getElementById("purchaseDateRow");
    const purchaseDateInput = document.getElementById("purchaseDate");

    const folioCompraInput = document.getElementById("folioCompra");
    const brandNumberInput = document.getElementById("brandNumber");
    const dnInput = document.getElementById("dn");
    const tipoOperacionRadios = document.querySelectorAll(
      'input[name="tipoOperacion"]'
    );

    gatewaySelect.addEventListener("change", () => {
      const gwValue = gatewaySelect.value;
      if (gwValue === "paypal") {
        purchaseDateRow.classList.remove("hidden");
      } else {
        purchaseDateRow.classList.add("hidden");
        purchaseDateInput.value = "";
      }
      validarFormularioYBoton();
    });

    function inferirTipoDesdeFolio(folio) {
      if (!folio || typeof folio !== "string") return null;
      const partes = folio.split("_");
      if (!partes[0]) return null;
      const prefijo = partes[0];
      if (prefijo.length === 4) return "recarga";
      if (prefijo.length === 3) return "compra";
      return null;
    }

    function validarFormularioYBoton() {
      const folio = folioCompraInput.value.trim();
      const dn = dnInput.value.trim();
      const gateway = gatewaySelect.value;
      const purchaseDate = purchaseDateInput.value.trim();
      const tipoSeleccionadoRadio = document.querySelector(
        'input[name="tipoOperacion"]:checked'
      );
      const tipoSeleccionado = tipoSeleccionadoRadio
        ? tipoSeleccionadoRadio.value
        : null;

      let valido = true;
      let mensajeAdvertencia = "";

      if (!folio) {
        valido = false;
      } else {
        const tipoInferido = inferirTipoDesdeFolio(folio);
        if (tipoInferido && tipoSeleccionado && tipoInferido !== tipoSeleccionado) {
          valido = false;
          mensajeAdvertencia =
            'El folio parece corresponder a una "' +
            tipoInferido +
            '" pero está seleccionado "' +
            tipoSeleccionado +
            '".';
        }
      }

      if (gateway === "paypal" && !purchaseDate) {
        valido = false;
      }

      if (!dn || !/^[0-9]{10}$/.test(dn)) {
        valido = false;
        if (!mensajeAdvertencia) {
          mensajeAdvertencia = "El DN debe ser numérico de exactamente 10 dígitos.";
        }
      }

      if (mensajeAdvertencia) {
        summaryMessage.textContent = mensajeAdvertencia;
      } else if (statusChip.classList.contains("status-idle")) {
        summaryMessage.textContent =
          "Ingresar folio de compra y ejecutar el flujo.";
      }

      runButton.disabled = !valido;
    }

    tipoOperacionRadios.forEach((radio) => {
      radio.addEventListener("change", validarFormularioYBoton);
    });

    folioCompraInput.addEventListener("input", validarFormularioYBoton);
    dnInput.addEventListener("input", validarFormularioYBoton);
    purchaseDateInput.addEventListener("input", validarFormularioYBoton);

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const folioCompra = folioCompraInput.value.trim();
      const brandNumber = brandNumberInput.value.trim();
      const tipoOperacionRadio = document.querySelector(
        'input[name="tipoOperacion"]:checked'
      );
      const tipoOperacion = tipoOperacionRadio ? tipoOperacionRadio.value : null;
      const gateway = gatewaySelect.value;
      const purchaseDate = purchaseDateInput ? purchaseDateInput.value.trim() : "";
      const dn = dnInput.value.trim();

      if (!folioCompra) return;
      if (!dn || !/^[0-9]{10}$/.test(dn)) return;

      setLoading(true);
      resetViewBeforeRun();
      setStatusRunning("Ejecutando flujo, esperando respuesta del backend...");

      const controller = new AbortController();
      const timeoutMs = 850000;
      const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

      try {
        const response = await fetch("/run-flow", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            folioCompra,
            brandNumber,
            gateway,
            tipoOperacion,
            purchaseDate,
            dn
          }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        const data = await response.json();
        const httpOk = response.ok;

        renderSummary(data, httpOk);
        renderSteps(data);
        renderDetails(data);

      } catch (err) {
        clearTimeout(timeoutId);

        let status = "ERROR_FRONT";
        let mensaje =
          "Error llamando al backend. Revisar conectividad o disponibilidad del servicio.";
        if (err.name === "AbortError") {
          status = "ERROR_FRONT_TIMEOUT";
          mensaje =
            "Tiempo de espera agotado al llamar al backend (más de 45 segundos sin respuesta).";
        }

        const errorData = {
          status,
          mensaje,
          detalle: err.message,
          log: ["Error en frontend: " + err.message]
        };
        renderSummary(errorData, false);
        renderSteps(errorData);
        renderDetails(errorData);
      } finally {
        setLoading(false);
      }
    });

    clearButton.addEventListener("click", () => {
      folioCompraInput.value = "";
      brandNumberInput.value = "";
      dnInput.value = "";
      gatewaySelect.value = "mercadopago";
      purchaseDateInput.value = "";
      purchaseDateRow.classList.add("hidden");

      const recargaRadio = document.querySelector(
        'input[name="tipoOperacion"][value="recarga"]'
      );
      if (recargaRadio) recargaRadio.checked = true;

      resetFullView();
      validarFormularioYBoton();
    });

    toggleDetailsButton.addEventListener("click", () => {
      if (
        detailsContainer.style.display === "none" ||
        detailsContainer.style.display === ""
      ) {
        detailsContainer.style.display = "block";
        toggleDetailsButton.textContent = "Ocultar detalles";
      } else {
        detailsContainer.style.display = "none";
        toggleDetailsButton.textContent = "Ver detalles";
      }
    });

    function setLoading(isLoading) {
      if (isLoading) {
        runButton.disabled = true;
        runButton.textContent = "Ejecutando...";
      } else {
        runButton.textContent = "Ejecutar flujo";
        validarFormularioYBoton();
      }
    }

    function setStatusRunning(texto) {
      statusChip.className = "status-bar status-running";
      const chipChildren = statusChip.querySelectorAll("span");
      const textSpan = chipChildren[1];
      textSpan.textContent = "Ejecutando";
      summaryMessage.textContent = texto;
    }

    function resetSummaryIdle() {
      statusChip.className = "status-bar status-idle";
      const chipChildren = statusChip.querySelectorAll("span");
      const textSpan = chipChildren[1];
      textSpan.textContent = "Listo para ejecutar";

      summaryMessage.textContent = "Ingresar folio de compra y ejecutar el flujo.";
      summaryKeyData.innerHTML = "";

      // ocultar botón de descarga y limpiar handler
      downloadReportContainer.classList.add("hidden");
      downloadReportButton.onclick = null;
    }

    function resetFullView() {
      resetSummaryIdle();
      stepsSection.classList.add("hidden");
      detailsSection.classList.add("hidden");

      stepsList.innerHTML = "";
      detailsPre.textContent = "";
      detailsContainer.style.display = "none";
      toggleDetailsButton.textContent = "Ver detalles";
    }

    function resetViewBeforeRun() {
      stepsSection.classList.add("hidden");
      detailsSection.classList.add("hidden");

      stepsList.innerHTML = "";
      detailsPre.textContent = "";
      detailsContainer.style.display = "none";
      toggleDetailsButton.textContent = "Ver detalles";

      downloadReportContainer.classList.add("hidden");
      downloadReportButton.onclick = null;
    }

    function computeReportUrlFromData(data) {
      if (!data || typeof data !== "object") return null;

      const preferredKeys = [
        "reportUrl",
        "reportFileName",
        "logFileName",
        "logFile",
        "txtFileName",
        "txtReport",
        "txtPath"
      ];

      for (const key of preferredKeys) {
        const value = data[key];
        if (typeof value === "string" && value.trim() !== "") {
          const raw = value.trim();
          if (/^https?:\/\//.test(raw) || raw.startsWith("/logs/")) {
            return raw;
          }
          const justName = raw.split("/").pop();
          return "/logs/" + justName;
        }
      }

      // fallback: busca cualquier propiedad string que termine en .txt
      for (const [k, v] of Object.entries(data)) {
        if (typeof v === "string" && v.trim().toLowerCase().endsWith(".txt")) {
          const raw = v.trim();
          if (/^https?:\/\//.test(raw) || raw.startsWith("/logs/")) {
            return raw;
          }
          const justName = raw.split("/").pop();
          return "/logs/" + justName;
        }
      }

      return null;
    }

    function renderSummary(data, httpOk) {
      const status = data.status || (httpOk ? "OK" : "ERROR");
      const mensaje = data.mensaje || "Sin mensaje";

      statusChip.className = "status-bar";
      const chipChildren = statusChip.querySelectorAll("span");
      const textSpan = chipChildren[1];

      if (status === "OK") {
        statusChip.classList.add("status-ok");
        textSpan.textContent = "Éxito";
      } else if (
        status === "SIN_RESULTADOS" ||
        status === "SIN_REGISTRO_PROD" ||
        status === "SIN_REGISTRO_PROD_PAYPAL" ||
        status === "SIN_REGISTRO_PROD_OPENPAY" ||
        status === "GATEWAY_NO_IMPLEMENTADO" ||
        status === "EXISTE_EN_UAT" ||
        status === "EXISTE_EN_UAT_PAYPAL" ||
        status === "EXISTE_EN_UAT_OPENPAY"
      ) {
        statusChip.classList.add("status-warning");
        textSpan.textContent = "Advertencia";
      } else if (status === "ERROR_FRONT_TIMEOUT") {
        statusChip.classList.add("status-error");
        textSpan.textContent = "Timeout";
      } else if (status === "ERROR_FRONT") {
        statusChip.classList.add("status-error");
        textSpan.textContent = "Error en frontend";
      } else {
        statusChip.classList.add("status-error");
        textSpan.textContent = "Error";
      }

      summaryMessage.textContent = mensaje;

      const keyParts = [];
      if (data.folioCompra) {
        keyParts.push("<strong>Folio compra:</strong> " + data.folioCompra);
      }
      if (data.folioMercado) {
        keyParts.push("<strong>Folio MP:</strong> " + data.folioMercado);
      }
      if (data.purchaseDate) {
        keyParts.push("<strong>Fecha compra:</strong> " + data.purchaseDate);
      }
      if (data.brandNumber) {
        keyParts.push("<strong>Marca:</strong> " + data.brandNumber);
      }
      if (data.dn) {
        keyParts.push("<strong>DN:</strong> " + data.dn);
      }
      if (data.gateway) {
        keyParts.push("<strong>Pasarela:</strong> " + data.gateway);
      }
      if (data.tipoOperacion) {
        keyParts.push("<strong>Tipo operación:</strong> " + data.tipoOperacion);
      }
      if (data.httpStatus) {
        keyParts.push("<strong>HTTP status:</strong> " + data.httpStatus);
      }

      summaryKeyData.innerHTML = keyParts.join("<br>");

      // Lógica para mostrar el botón de descarga del reporte TXT de esta ejecución
      const reportUrl = computeReportUrlFromData(data);
      if (reportUrl) {
        downloadReportContainer.classList.remove("hidden");
        downloadReportButton.onclick = () => {
          window.open(reportUrl, "_blank");
        };
      } else {
        downloadReportContainer.classList.add("hidden");
        downloadReportButton.onclick = null;
      }
    }

    function renderSteps(data) {
      stepsSection.classList.remove("hidden");
      stepsList.innerHTML = "";

      const logs = Array.isArray(data.log) ? data.log : [];
      if (logs.length === 0) {
        const li = document.createElement("li");
        li.className = "step-neutral";
        li.innerHTML =
          '<span class="step-icon"></span><span class="step-text">Sin log disponible</span>';
        stepsList.appendChild(li);
        return;
      }

      logs.forEach((entry) => {
        const li = document.createElement("li");
        let cls = "step-neutral";

        const upper = entry.toUpperCase();
        if (upper.includes("ERROR")) {
          cls = "step-error";
        } else if (
          upper.includes("RESPONDIÓ CORRECTAMENTE") ||
          upper.includes("ENCONTRADO") ||
          upper.includes("OK") ||
          upper.includes("VERIFICADO") ||
          upper.includes("CONSIDERADO EXITOSO")
        ) {
          cls = "step-ok";
        }

        li.className = cls;
        li.innerHTML =
          '<span class="step-icon"></span><span class="step-text">' +
          entry +
          "</span>";
        stepsList.appendChild(li);
      });
    }

    function renderDetails(data) {
      detailsSection.classList.remove("hidden");
      detailsPre.textContent = JSON.stringify(data, null, 2);
      detailsContainer.style.display = "none";
      toggleDetailsButton.textContent = "Ver detalles";
    }

    resetFullView();
    validarFormularioYBoton();
  </script>
  <footer>
    <p style="text-align: center; font-size: 0.8rem; color: var(--text-muted);">
      &copy; 2025 Villegas Olvera Edgar.
    </p>
  </footer>
</body>
</html>